# 1 Story Metadata

| Property | Value |
|----------|-------|
| Story Id | CUS-004 |
| Elaboration Date | 2024-10-27 |
| Development Readiness | Complete |

# 2 Story Narrative

| Property | Value |
|----------|-------|
| Title | Customer Login Error for Invalid OTP |
| As A User Story | As a registered customer attempting to log in, I w... |
| User Persona | A registered Customer using the mobile application... |
| Business Value | Improves the user experience by providing clear, a... |
| Functional Area | User Management & Authentication |
| Story Theme | Customer Onboarding and Access |

# 3 Acceptance Criteria

## 3.1 Criteria Id

### 3.1.1 Criteria Id

AC-001

### 3.1.2 Scenario

User enters an incorrect (non-matching) OTP

### 3.1.3 Scenario Type

Error_Condition

### 3.1.4 Given

a customer has initiated login with their mobile number and is on the OTP entry screen

### 3.1.5 When

the customer enters an OTP that does not match the one generated by the system and submits it

### 3.1.6 Then

the system must reject the authentication attempt, the user must remain on the OTP entry screen, a specific error message 'Invalid OTP. Please try again.' must be displayed inline near the input field, and a failed login attempt must be logged against the user's account for this session.

### 3.1.7 Validation Notes

Verify via E2E test that the user is not logged in and the error message appears. Check server logs or a test endpoint to confirm the failed attempt counter was incremented.

## 3.2.0 Criteria Id

### 3.2.1 Criteria Id

AC-002

### 3.2.2 Scenario

User submits an empty OTP field

### 3.2.3 Scenario Type

Error_Condition

### 3.2.4 Given

a customer is on the OTP entry screen

### 3.2.5 When

the customer taps the 'Verify' or 'Submit' button without entering any digits

### 3.2.6 Then

the app must display a client-side validation error message such as 'Please enter the OTP.' and must not make an API call to the backend.

### 3.2.7 Validation Notes

Manual and automated UI testing. Verify no network request is sent for OTP validation.

## 3.3.0 Criteria Id

### 3.3.1 Criteria Id

AC-003

### 3.3.2 Scenario

User enters an expired OTP

### 3.3.3 Scenario Type

Edge_Case

### 3.3.4 Given

a customer has received an OTP which has now passed its validity period

### 3.3.5 When

the customer enters the correct but expired OTP and submits it

### 3.3.6 Then

the system must reject the authentication, the user must remain on the OTP screen, and a specific error message 'OTP has expired. Please request a new one.' must be displayed.

### 3.3.7 Validation Notes

Requires the ability to manipulate time in a test environment or wait for the OTP to naturally expire. The API response should clearly distinguish this case from a simply incorrect OTP.

## 3.4.0 Criteria Id

### 3.4.1 Criteria Id

AC-004

### 3.4.2 Scenario

Error message UI and interaction

### 3.4.3 Scenario Type

Happy_Path

### 3.4.4 Given

an invalid OTP has been submitted

### 3.4.5 When

the error message is displayed

### 3.4.6 Then

the message must be clearly visible, styled to indicate an error (e.g., red text), the OTP input field may have its border highlighted in red, and the user can immediately edit the input field to try again.

### 3.4.7 Validation Notes

UI review and E2E testing to confirm the visual state and that the input field remains active.

# 4.0.0 User Interface Requirements

## 4.1.0 Ui Elements

- OTP input field (segmented for 4 or 6 digits)
- Error message text label (initially hidden)
- Verify/Submit button

## 4.2.0 User Interactions

- On submission of an invalid OTP, the error message appears.
- The user can immediately re-type in the OTP field after the error is shown.
- The screen should not perform a full reload; the error should appear dynamically.

## 4.3.0 Display Requirements

- Error messages must be specific to the error type (invalid vs. expired).
- The error message should be positioned directly below or adjacent to the OTP input field for clear context.

## 4.4.0 Accessibility Needs

- The error message must be programmatically linked to the input field (e.g., using `aria-describedby` for web or equivalent for native) so screen readers announce it. (Ref: REQ-INT-001)
- Color should not be the only means of conveying the error.

# 5.0.0 Business Rules

- {'rule_id': 'BR-001', 'rule_description': 'Each invalid OTP submission for a given login attempt must be counted as a failed attempt.', 'enforcement_point': 'Backend Authentication Service, upon validating the OTP.', 'violation_handling': 'The counter is incremented. This counter is used by the logic in story CUS-005 to trigger an account lockout.'}

# 6.0.0 Dependencies

## 6.1.0 Prerequisite Stories

- {'story_id': 'CUS-003', 'dependency_reason': 'The core OTP login flow, including OTP generation and the UI screen for entry, must exist before error handling can be implemented.'}

## 6.2.0 Technical Dependencies

- Backend Authentication microservice with an endpoint to validate OTPs.
- AWS Cognito for user authentication management as per REQ-NFR-003.
- A caching mechanism (e.g., Redis) to store the OTP and the failed attempt counter for the user's session.

## 6.3.0 Data Dependencies

- Requires access to the generated OTP and its expiry timestamp for a specific user's login session.

## 6.4.0 External Dependencies

*No items available*

# 7.0.0 Non Functional Requirements

## 7.1.0 Performance

- The API response time for OTP validation (both success and failure) must be under 200ms (P95) as per REQ-NFR-001.

## 7.2.0 Security

- Error messages must not reveal whether a mobile number is registered or not; this story only applies after a valid number has been entered.
- Error messages must be generic ('Invalid OTP') and not hint at which part of the OTP is incorrect to prevent enumeration attacks.
- All failed attempts must be logged securely on the server-side.

## 7.3.0 Usability

- The feedback for an incorrect entry must be immediate and clear to avoid user confusion.

## 7.4.0 Accessibility

- Must comply with WCAG 2.1 Level AA standards as per REQ-INT-001.

## 7.5.0 Compatibility

- Functionality must be consistent across all supported iOS and Android versions.

# 8.0.0 Implementation Considerations

## 8.1.0 Complexity Assessment

Low

## 8.2.0 Complexity Factors

- Standard form validation on the client-side.
- Simple API endpoint logic on the backend.
- Requires state management on the client to display the error message without a page refresh.
- Integration with a counter in a cache like Redis for tracking failed attempts.

## 8.3.0 Technical Risks

- Ensuring the failed attempt counter is atomic and handles concurrent requests correctly, although unlikely for a single user's login.

## 8.4.0 Integration Points

- Client Application (React Native) -> API Gateway -> Authentication Service
- Authentication Service -> AWS Cognito (for validation logic)
- Authentication Service -> Redis (for session data like OTP and failure count)

# 9.0.0 Testing Requirements

## 9.1.0 Testing Types

- Unit
- Integration
- E2E

## 9.2.0 Test Scenarios

- Submit a correct OTP (covered in CUS-003 but useful for baseline).
- Submit an incorrect OTP.
- Submit a blank OTP.
- Submit an expired OTP.
- Verify the UI state change when an error is returned.

## 9.3.0 Test Data Needs

- A registered test user account.
- Ability to retrieve the generated OTP for a test session to script valid/invalid attempts.
- Ability to mock the system clock to test the OTP expiry scenario.

## 9.4.0 Testing Tools

- Jest / React Testing Library for frontend unit/integration tests.
- Cypress for E2E tests.
- Postman or similar for API-level integration tests.

# 10.0.0 Definition Of Done

- All acceptance criteria validated and passing in a staging environment.
- Code has been peer-reviewed and merged into the main branch.
- Unit and integration tests are written and achieve >80% code coverage for the new logic.
- Automated E2E tests for the invalid OTP scenario are passing.
- UI meets the design and accessibility requirements.
- API performance is verified to be within the defined limits.
- The failed attempt counter is confirmed to be incrementing correctly.
- No regressions are introduced in the successful login flow.
- Story is deployed and verified in the staging environment.

# 11.0.0 Planning Information

## 11.1.0 Story Points

1

## 11.2.0 Priority

ðŸ”´ High

## 11.3.0 Sprint Considerations

- This story is part of the critical path for user authentication.
- It should be developed in the same sprint as CUS-003 (Login) and CUS-005 (Lockout) to deliver a complete login error-handling feature.
- Requires coordination between frontend and backend developers.

## 11.4.0 Release Impact

Essential for the initial launch. A login feature cannot be released without proper error handling.

